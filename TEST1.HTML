<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î‡∏ô‡πâ‡∏≥ & ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏ñ (Joystick)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{min-height:100vh;background:#0f172a;color:#e5e7eb;display:flex;justify-content:center;align-items:flex-start;padding:20px}
    .app{width:100%;max-width:900px;background:#020617;border-radius:20px;padding:24px;box-shadow:0 20px 40px rgba(0,0,0,0.5);border:1px solid #1f2937}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:10px}
    .title{font-size:1.4rem;font-weight:700}
    .subtitle{font-size:0.9rem;color:#9ca3af}
    .status-indicator{font-size:0.8rem;padding:6px 10px;border-radius:999px;background:#111827;border:1px solid #374151}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:999px;background:#f97316;margin-right:6px}
    .grid{display:flex;gap:16px;flex-wrap:wrap}
    .card{flex:1 1 320px;background:#020617;border-radius:16px;border:1px solid #1f2937;padding:16px 16px 18px}
    .card h2{font-size:1.1rem;margin-bottom:4px}
    .card p{font-size:0.85rem;color:#9ca3af;margin-bottom:12px}
    .section-label{font-size:0.8rem;color:#9ca3af;margin-bottom:6px}
    .btn{border:none;border-radius:999px;padding:8px 14px;font-size:0.9rem;cursor:pointer;background:#1d4ed8;color:white;margin-right:6px;margin-bottom:6px;transition:transform .08s ease,box-shadow .08s ease;background 0.12s;box-shadow:0 6px 14px rgba(37,99,235,0.4)}
    .btn.secondary{background:#111827;color:#e5e7eb;box-shadow:none;border:1px solid #374151}
    .btn.danger{background:#b91c1c;box-shadow:0 6px 14px rgba(185,28,28,0.4)}
    .btn:active{transform:translateY(1px) scale(.97);box-shadow:0 3px 7px rgba(0,0,0,.4)}
    .center-label{font-size:0.7rem;color:#9ca3af;text-align:center;margin-bottom:8px}
    .log-box{margin-top:14px;font-size:0.8rem;background:#020617;border-radius:10px;border:1px solid #111827;padding:8px 10px;max-height:160px;overflow-y:auto}
    .log-line{margin-bottom:4px;color:#9ca3af}
    .log-line span.time{color:#6b7280;margin-right:4px}
    .log-line.ok{color:#22c55e}
    .log-line.err{color:#f97316}
    .water-options{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px}
    .water-custom{display:flex;align-items:center;gap:6px;margin:4px 0 8px;font-size:0.8rem}
    .water-custom input{width:70px;padding:4px 6px;border-radius:999px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:0.8rem;outline:none}
    .footer{margin-top:18px;font-size:0.7rem;text-align:right;color:#6b7280}
    /* Joystick */
    .joystick-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
    .joy-area{position:relative;width:220px;height:220px;border-radius:50%;background:linear-gradient(180deg,#0b1220,#07121a);border:2px solid #1f2937;display:flex;align-items:center;justify-content:center;touch-action:none}
    .joy-grid{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr 1fr;pointer-events:none}
    .knob{position:absolute;width:80px;height:80px;border-radius:50%;background:#1d4ed8;border:6px solid rgba(255,255,255,0.06);box-shadow:0 8px 20px rgba(29,78,216,0.24);touch-action:none;display:flex;align-items:center;justify-content:center;font-weight:700}
    .stop-big{padding:12px 18px;border-radius:12px;background:#b91c1c;color:white;border:none;font-weight:700;box-shadow:0 8px 20px rgba(185,28,28,0.18);cursor:pointer}
    .speed-controls{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px}
    @media(max-width:640px){.joy-area{width:180px;height:180px}.knob{width:72px;height:72px}}
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div>
        <div class="title">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î‡∏ô‡πâ‡∏≥ & ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏ñ</div>
        <div class="subtitle">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ö‡∏≠‡∏£‡πå‡∏î/‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚Äî ‡πÅ‡∏ö‡∏ö‡∏à‡∏≠‡∏¢‡∏™‡∏ï‡∏¥‡∏Å</div>
      </div>
      <div class="status-indicator" id="connectionStatus">
        <span class="status-dot" id="statusDot"></span>
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
      </div>
    </header>

    <main class="grid">
      <!-- ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î‡∏ô‡πâ‡∏≥ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) -->
      <section class="card">
        <h2>‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î‡∏ô‡πâ‡∏≥ üíß</h2>
        <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏≠‡∏£‡πå‡∏î</p>

        <div class="section-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏ö‡∏ö‡∏î‡πà‡∏ß‡∏ô</div>
        <div class="water-options">
          <button class="btn" onclick="sendWaterPreset(50)">50 ml</button>
          <button class="btn" onclick="sendWaterPreset(100)">100 ml</button>
          <button class="btn" onclick="sendWaterPreset(200)">200 ml</button>
        </div>

        <div class="water-custom">
          <span>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á:</span>
          <input type="number" id="waterAmountInput" min="1" max="1000" placeholder="‡πÄ‡∏ä‡πà‡∏ô 150" />
          <span>ml</span>
          <button class="btn secondary" onclick="sendCustomWater()">‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î</button>
        </div>

        <button class="btn danger" onclick="sendWaterStop()">‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î</button>

        <div class="log-box" id="waterLog"></div>
      </section>

      <!-- ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏ñ (‡∏à‡∏≠‡∏¢‡∏™‡∏ï‡∏¥‡∏Å) -->
      <section class="card">
        <h2>‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏ñ (‡∏à‡∏≠‡∏¢‡∏™‡∏ï‡∏¥‡∏Å) üöó</h2>
        <p>‡∏•‡∏≤‡∏Å‡∏à‡∏≠‡∏¢‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß ‚Äî ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° STOP</p>

        <div class="joystick-wrap">
          <div class="joy-area" id="joyArea" aria-label="joystick area">
            <div class="joy-grid"></div>
            <div class="knob" id="knob">‚óè</div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;">
            <div class="speed-controls">
              <button class="btn secondary" onclick="setSpeed(30)">‡∏ä‡πâ‡∏≤</button>
              <button class="btn secondary" onclick="setSpeed(60)">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</button>
              <button class="btn secondary" onclick="setSpeed(100)">‡πÄ‡∏£‡πá‡∏ß</button>
            </div>
            <button class="stop-big" id="bigStop" onclick="manualStop()">STOP</button>
          </div>
        </div>

        <div class="log-box" id="driveLog"></div>
      </section>
    </main>

    <footer class="footer">* ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤ <code>API_URL</code> ‡πÉ‡∏ô JavaScript ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î/‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</footer>
  </div>

  <script>
    // ======= ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà =======
    const API_URL = "http://192.168.4.1/api/command"; // <--- ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á ESP32 ‡∏´‡∏£‡∏∑‡∏≠ endpoint ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    let currentSpeed = 60; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 0-100
    let joystickInterval = null;
    let joystickActive = false;
    let lastSent = 0;

    // ---------- HTTP helper ----------
    async function sendCommand(type, payload = {}) {
      const timestamp = new Date().toLocaleTimeString();
      const body = { type, ...payload };

      try {
        updateStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á...", "orange");

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json().catch(() => ({}));
        updateStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "green");
        return { ok: true, data, time: timestamp };
      } catch (err) {
        updateStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / ‡πÑ‡∏°‡πà‡∏°‡∏µ API", "orange");
        return { ok: false, error: err.message, time: timestamp };
      }
    }

    function updateStatus(text, color = "orange") {
      const statusDiv = document.getElementById("connectionStatus");
      const dot = document.getElementById("statusDot");
      // replace text after dot
      statusDiv.lastChild.textContent = " " + text;
      dot.style.background = color === "green" ? "#22c55e" : color === "red" ? "#b91c1c" : "#f97316";
    }

    function appendLog(elementId, message, status = "normal") {
      const box = document.getElementById(elementId);
      const div = document.createElement("div");
      div.classList.add("log-line");
      if (status === "ok") div.classList.add("ok");
      if (status === "err") div.classList.add("err");

      const timeSpan = document.createElement("span");
      timeSpan.classList.add("time");
      timeSpan.textContent = "[" + new Date().toLocaleTimeString() + "] ";

      div.appendChild(timeSpan);
      div.appendChild(document.createTextNode(message));
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    // ---------- Water functions (unchanged) ----------
    async function sendWaterPreset(amountMl) {
      appendLog("waterLog", `‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î‡∏ô‡πâ‡∏≥ ${amountMl} ml ...`);
      const result = await sendCommand("water_dispense", { amount_ml: amountMl });
      if (result.ok) appendLog("waterLog", `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏î‡∏ô‡πâ‡∏≥ ${amountMl} ml`, "ok");
      else appendLog("waterLog", `‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"}`, "err");
    }

    async function sendCustomWater() {
      const input = document.getElementById("waterAmountInput");
      const value = parseInt(input.value, 10);
      if (isNaN(value) || value <= 0) { appendLog("waterLog", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0", "err"); return; }
      await sendWaterPreset(value);
    }

    async function sendWaterStop() {
      appendLog("waterLog", "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î...");
      const result = await sendCommand("water_stop");
      if (result.ok) appendLog("waterLog", "‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "ok");
      else appendLog("waterLog", `‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"}`, "err");
    }

    // ---------- Drive / Joystick ----------
    function setSpeed(v) {
      currentSpeed = v;
      appendLog("driveLog", `‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: ${v}%`, "ok");
    }

    async function sendDrive(direction, speed = currentSpeed, extra = {}) {
      appendLog("driveLog", `‡∏™‡∏±‡πà‡∏á‡∏£‡∏ñ: ${direction} (${speed}%) ...`);
      const result = await sendCommand("drive", { direction, speed, ...extra });
      if (result.ok) appendLog("driveLog", `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${direction}`, "ok");
      else appendLog("driveLog", `‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"}`, "err");
    }

    function manualStop() {
      // ‡∏™‡πà‡∏á stop ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      appendLog("driveLog", "‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î (STOP) ...");
      sendDrive("stop", 0);
      // reset knob
      resetKnob();
    }

    // ---------- Joystick logic ----------
    const joyArea = document.getElementById("joyArea");
    const knob = document.getElementById("knob");
    const areaRect = () => joyArea.getBoundingClientRect();
    const maxRadius = () => areaRect().width / 2 - knob.offsetWidth / 2;

    let origin = { x: 0, y: 0 };
    let pointerId = null;

    function toLocal(e) {
      const r = areaRect();
      let clientX, clientY;
      if (e.touches && e.touches[0]) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
      else { clientX = e.clientX; clientY = e.clientY; }
      return { x: clientX - r.left - r.width / 2, y: clientY - r.top - r.height / 2 };
    }

    function clamp(value, min, max) { return Math.max(min, Math.min(max, value)); }

    function setKnobPos(dx, dy) {
      const maxR = maxRadius();
      const dist = Math.hypot(dx, dy);
      const factor = dist > maxR ? maxR / dist : 1;
      const nx = dx * factor;
      const ny = dy * factor;
      knob.style.transform = `translate(${nx}px, ${ny}px)`;
    }

    function resetKnob() {
      knob.style.transform = `translate(0px, 0px)`;
      joystickActive = false;
      stopJoystickInterval();
    }

    function startJoystickInterval(getPayload) {
      stopJoystickInterval();
      joystickInterval = setInterval(() => {
        // throttle to 80-150ms by timestamp as well (avoid spamming)
        const now = Date.now();
        if (now - lastSent < 80) return;
        lastSent = now;
        const p = getPayload();
        if (p.active) {
          sendDrive(p.direction, p.speed, { x: p.x || 0, y: p.y || 0 });
        } else {
          sendDrive("stop", 0);
        }
      }, 120);
    }

    function stopJoystickInterval() {
      if (joystickInterval) { clearInterval(joystickInterval); joystickInterval = null; }
    }

    function computeDirectionAndSpeed(dx, dy) {
      // dx,right +, dy,down +
      const dist = Math.hypot(dx, dy);
      const maxR = maxRadius();
      const norm = clamp(dist / maxR, 0, 1);
      const speed = Math.round(currentSpeed * norm);

      // angle in degrees (0 = right, 90 = down)
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      // map to 8 directions
      // right: -22..22, down-right:23..67, down:68..112, down-left:113..157,
      // left:158..-158, up-left:-157..-113, up:-112..-68, up-right:-67..-23
      let dir = "stop";
      if (norm < 0.15) dir = "stop";
      else if (angle >= -22 && angle <= 22) dir = "right";
      else if (angle > 22 && angle <= 67) dir = "down-right";
      else if (angle > 67 && angle <= 112) dir = "down";
      else if (angle > 112 && angle <= 157) dir = "down-left";
      else if (angle > 157 || angle <= -157) dir = "left";
      else if (angle > -157 && angle <= -112) dir = "up-left";
      else if (angle > -112 && angle <= -67) dir = "up";
      else if (angle > -67 && angle < -22) dir = "up-right";

      return { direction: dir, speed, x: Math.round(dx), y: Math.round(dy), active: dir !== "stop" };
    }

    // Pointer / touch handlers
    function onStart(e) {
      e.preventDefault();
      joystickActive = true;
      const p = toLocal(e);
      setKnobPos(p.x, p.y);
      startJoystickInterval(() => computeDirectionAndSpeed(p.x, p.y));
      // for continuous updates, replace getPayload closure on move
      pointerId = (e.pointerId !== undefined) ? e.pointerId : null;
    }

    function onMove(e) {
      if (!joystickActive) return;
      e.preventDefault();
      const p = toLocal(e);
      setKnobPos(p.x, p.y);
      // update interval payload by swapping closure:
      // We'll stop and restart interval with updated closure (cheap)
      startJoystickInterval(() => computeDirectionAndSpeed(p.x, p.y));
    }

    function onEnd(e) {
      e && e.preventDefault();
      resetKnob();
      // send stop immediately
      sendDrive("stop", 0);
    }

    // attach events: touch + mouse
    joyArea.addEventListener("touchstart", (e) => onStart(e), { passive: false });
    joyArea.addEventListener("touchmove", (e) => onMove(e), { passive: false });
    joyArea.addEventListener("touchend", (e) => onEnd(e));
    joyArea.addEventListener("mousedown", (e) => { onStart(e); window.addEventListener("mousemove", onMove); window.addEventListener("mouseup", onEnd, { once: true }); });
    joyArea.addEventListener("mouseup", onEnd);

    // Keyboard fallback: WASD / Space => map to directions
    window.addEventListener("keydown", function(e) {
      const key = e.key.toLowerCase();
      if (["w","a","s","d"," "].includes(key)) e.preventDefault();
      switch(key) {
        case "w": sendDrive("up", currentSpeed); break;
        case "s": sendDrive("down", currentSpeed); break;
        case "a": sendDrive("left", currentSpeed); break;
        case "d": sendDrive("right", currentSpeed); break;
        case " ": manualStop(); break;
      }
    });

    // Cleanup on page hide
    window.addEventListener("blur", () => { manualStop(); });

    // initial status
    updateStatus("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠", "orange");
  </script>
</body>
</html>
